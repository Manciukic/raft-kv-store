package org.example;

import javax.ejb.Stateless;
import java.io.IOException;
import java.util.*;

import com.ericsson.otp.erlang.*;
import java.util.List;

@Stateless(name = "SessionEJB")
public class SessionBean implements KeyValueStore{
    private static final String serverNodeName = "avg_node@localhost"; //configuration parameter
    private static final String serverRegisteredName = "avg_server"; //configuration parameter
    private static final String clientNodeName = "avg_client_node@localhost"; //configuration parameter
    private  OtpNode clientNode;  //initialized in constructor
    String cookie="";
    private final OtpMbox mbox;

    //constructor
    public SessionBean() {
        try {
            if (!cookie.equals("")) {
                clientNode = new OtpNode(clientNodeName, cookie);
            }
            else {
                clientNode = new OtpNode(clientNodeName);
            }

        } catch (IOException e) {
            e.printStackTrace();
        }
        mbox = clientNode.createMbox("client_mbox_");
        System.out.println("Created mailbox "+ mbox.getName());

    }

    @Override
    public String get(String key) throws OtpErlangExit, OtpErlangDecodeException {

        OtpErlangString Erlkey = new OtpErlangString(key);
        OtpErlangString get = new OtpErlangString("get");
        OtpErlangTuple arg = new OtpErlangTuple(Erlkey);
        OtpErlangTuple reqMsg = new OtpErlangTuple(new OtpErlangObject[]{this.mbox.self(), get,arg});

        //sending out the request
        mbox.send(serverRegisteredName, serverNodeName, reqMsg);
        //blocking receive operation
        OtpErlangObject msg = mbox.receive();
        //getting the message content
        OtpErlangString ErlStr = (OtpErlangString) msg;//it is supposed to be a tuple...
        String value=ErlStr.stringValue();

        return value;
    }

    @Override
    public List<String> getAll() throws OtpErlangExit, OtpErlangDecodeException {

        OtpErlangString get = new OtpErlangString("get_all");

        OtpErlangTuple Arg = new OtpErlangTuple(new OtpErlangObject[]{});
        OtpErlangTuple reqMsg = new OtpErlangTuple(new OtpErlangObject[]{this.mbox.self(), get,Arg});

        //sending out the request
        mbox.send(serverRegisteredName, serverNodeName, reqMsg);
        //blocking receive operation
        OtpErlangObject msg = mbox.receive();
        //getting the message content
        OtpErlangList erlList = (OtpErlangList) msg;
        List<String> values = new LinkedList<String>();

        for (OtpErlangObject erlO : erlList) {
            values.add(erlO.toString());
        }
        return values;

    }

    @Override
    public boolean set(String key, String value) throws OtpErlangExit, OtpErlangDecodeException {

        OtpErlangString Erlkey = new OtpErlangString(key);

        OtpErlangString Erlval = new OtpErlangString(value);
        OtpErlangTuple arg = new OtpErlangTuple(new OtpErlangObject[]{Erlkey,Erlval});
        OtpErlangString set = new OtpErlangString("set");

        OtpErlangTuple reqMsg = new OtpErlangTuple(new OtpErlangObject[]{this.mbox.self(), set,arg});

        //sending out the request
        mbox.send(serverRegisteredName, serverNodeName, reqMsg);
        //blocking receive operation
        OtpErlangObject msg = mbox.receive();
        //getting the message content
        OtpErlangAtom ErlStr = (OtpErlangAtom) msg;//it is supposed to be a tuple...
        if (ErlStr.atomValue().equals("ok"))
            return true;
        else
        return false;
    }

    @Override
    public boolean delete(String key) {
        OtpErlangString Erlkey = new OtpErlangString(key);
        OtpErlangString del = new OtpErlangString("delete");

        OtpErlangTuple reqMsg = new OtpErlangTuple(new OtpErlangObject[]{this.mbox.self(), del,Erlkey});

        //sending out the request
        mbox.send(serverRegisteredName, serverNodeName, reqMsg);
        //blocking receive operation
        OtpErlangObject msg = null;
        try {
            msg = mbox.receive();
        } catch (OtpErlangExit otpErlangExit) {
            otpErlangExit.printStackTrace();
        } catch (OtpErlangDecodeException e) {
            e.printStackTrace();
        }
        //getting the message content
        OtpErlangAtom Erlresp = (OtpErlangAtom) msg;
        if (Erlresp.atomValue().equals("ok"))
            return true;
        else
            return false;

    }

    @Override
    public boolean deleteAll() {

        OtpErlangString del = new OtpErlangString("delete_all");

        OtpErlangTuple reqMsg = new OtpErlangTuple(new OtpErlangObject[]{this.mbox.self(), del,});

        //sending out the request
        mbox.send(serverRegisteredName, serverNodeName, reqMsg);
        //blocking receive operation
        OtpErlangObject msg = null;
        try {
            msg = mbox.receive();
        } catch (OtpErlangExit otpErlangExit) {
            otpErlangExit.printStackTrace();
        } catch (OtpErlangDecodeException e) {
            e.printStackTrace();
        }
        //getting the message content
        OtpErlangAtom Erlresp = (OtpErlangAtom) msg;
        if (Erlresp.atomValue().equals("ok"))
            return true;
        else
            return false;
    }
}






